<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <meta name="theme-color" content="#2563eb" />
  <title>TaskMaster • Suivi & Défis</title>
  <link rel="manifest" href="manifest.json">
  <link rel="manifest" href="manifest.webmanifest">
  <link rel="icon" href="./icons/icon-192.png">
  <script src="https://cdn.tailwindcss.com"></script>
  <style>html,body,#root{height:100%}</style>

  <!-- React -->
  <script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
  <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
  <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
</head>
<body class="bg-gray-50">
  <div id="root"></div>

  <script type="text/babel">
    const { useState, useEffect } = React;
    const STORAGE_KEY = "taskmaster_v1";

    // Load/Save helpers
    const load = () => { try { return JSON.parse(localStorage.getItem(STORAGE_KEY)) || null; } catch(e){ return null; } };
    const save = (state) => localStorage.setItem(STORAGE_KEY, JSON.stringify(state));

    // Default demo state
    const demo = {
      currentUser: { id: 0, name: "Moi", avatar: "😊", streak: 3, totalPoints: 42, level: 2 },
      friends: [
        { id: 1, name: "Marie", email: "marie@example.com", avatar: "👩", streak: 5, totalPoints: 120, status: "active" },
        { id: 2, name: "Thomas", email: "thomas@example.com", avatar: "👨", streak: 2, totalPoints: 60, status: "active" },
      ],
      tasks: [
        { id: 1, title: "Réviser magnétostriction", description:"20 min", priority:"high", category:"personnel", dueDate: new Date().toISOString().slice(0,10), completed:false, createdAt:new Date().toISOString() },
        { id: 2, title: "Course 30 min", description:"Cardio", priority:"medium", category:"sante", dueDate: "", completed:false, createdAt:new Date().toISOString() },
      ]
    };

    const categories = {
      personnel: { label: 'Personnel', color: 'bg-blue-500', emoji: '👤' },
      travail: { label: 'Travail', color: 'bg-purple-500', emoji: '💼' },
      shopping: { label: 'Shopping', color: 'bg-green-500', emoji: '🛒' },
      sante: { label: 'Santé', color: 'bg-red-500', emoji: '❤️' },
      loisirs: { label: 'Loisirs', color: 'bg-orange-500', emoji: '🎨' }
    };
    const priorities = {
      low: { label: 'Faible', color: 'bg-green-100 text-green-800', icon: '●', points: 1 },
      medium: { label: 'Moyenne', color: 'bg-yellow-100 text-yellow-800', icon: '●●', points: 2 },
      high: { label: 'Élevée', color: 'bg-red-100 text-red-800', icon: '●●●', points: 3 }
    };

    function App(){
      const [state, setState] = useState(()=> load() ?? demo);
      const [tab, setTab] = useState("tasks");
      const [showModal, setShowModal] = useState(false);
      const [editing, setEditing] = useState(null);
      const [search, setSearch] = useState("");
      const [filter, setFilter] = useState("all");

      useEffect(()=> save(state), [state]);

      const stats = getStats(state.tasks);
      const leaderboard = getLeaderboard(state);
      const filtered = state.tasks.filter(t => {
        const q = (t.title + " " + (t.description||"")).toLowerCase();
        if(!q.includes(search.toLowerCase())) return false;
        const today = new Date().toISOString().slice(0,10);
        if(filter==="completed") return t.completed;
        if(filter==="pending") return !t.completed;
        if(filter==="today") return t.dueDate===today;
        if(filter==="overdue") return t.dueDate && t.dueDate < today && !t.completed;
        return true;
      });

      function addOrUpdate(task){
        if(editing){
          setState(s=>({...s, tasks: s.tasks.map(x=> x.id===editing.id? {...editing, ...task}: x)}));
          setEditing(null);
        }else{
          const id = Date.now();
          setState(s=>({...s, tasks: [{id, completed:false, createdAt:new Date().toISOString(), ...task}, ...s.tasks]}));
        }
        setShowModal(false);
      }

      function toggle(t){
        setState(s=>({...s, tasks: s.tasks.map(x=> x.id===t.id? {...x, completed: !x.completed, completedAt: !x.completed? new Date().toISOString(): null }: x)}));
        if(!t.completed){
          const pts = scoreTask(t);
          setState(s=>({...s, currentUser:{...s.currentUser, totalPoints: s.currentUser.totalPoints + pts, level: userLevel(s.currentUser.totalPoints + pts)}}));
        }
      }

      function remove(t){ setState(s=>({...s, tasks: s.tasks.filter(x=>x.id!==t.id)})); }

      function exportJSON(){
        const blob = new Blob([JSON.stringify(state,null,2)], {type:"application/json"});
        const url = URL.createObjectURL(blob);
        const a = document.createElement("a"); a.href=url; a.download="taskmaster_export.json"; a.click(); URL.revokeObjectURL(url);
      }
      function importJSON(e){
        const f = e.target.files?.[0]; if(!f) return;
        const r = new FileReader(); r.onload=()=>{ try{ setState(JSON.parse(r.result)); }catch(_){ alert("JSON invalide"); } }; r.readAsText(f);
      }

      return (
        <div className="h-full flex flex-col">
          <header className="bg-white border-b sticky top-0 z-10">
            <div className="max-w-5xl mx-auto p-3 flex items-center justify-between">
              <div className="flex items-center gap-3">
                <span className="text-2xl">🔥</span>
                <h1 className="font-bold">TaskMaster</h1>
                <div className="ml-2 text-sm text-gray-500">Streak: {state.currentUser.streak} • Points: <span className="font-semibold">{state.currentUser.totalPoints}</span> • Niveau {state.currentUser.level}</div>
              </div>
              <div className="flex items-center gap-2">
                <input className="px-3 py-2 border rounded-lg" placeholder="Recherche..." value={search} onChange={e=>setSearch(e.target.value)} />
                <label className="px-3 py-2 border rounded-lg cursor-pointer">
                  Importer
                  <input type="file" className="hidden" accept="application/json" onChange={importJSON} />
                </label>
                <button className="px-3 py-2 border rounded-lg" onClick={exportJSON}>Exporter</button>
                <button className="px-3 py-2 border rounded-lg" onclick="">
                  <span id="installPWA">Installer</span>
                </button>
              </div>
            </div>
            <nav className="max-w-5xl mx-auto px-3 pb-3 flex gap-2">
              {["tasks","competition","friends"].map(k=>(
                <button key={k} onClick={()=>setTab(k)} className={"px-3 py-2 rounded-lg " + (tab===k?"bg-blue-600 text-white":"bg-gray-100 text-gray-700")}>
                  {k==="tasks"?"Mes tâches":k==="competition"?"Compétition":"Amis"}
                </button>
              ))}
            </nav>
          </header>

          <main className="max-w-5xl mx-auto p-3 flex-1 w-full">
            {tab==="tasks" && (
              <div>
                <div className="grid grid-cols-5 gap-2 mb-3">
                  <Stat label="Total" value={stats.total} color="text-blue-600 bg-blue-50" />
                  <Stat label="Terminées" value={stats.completed} color="text-green-600 bg-green-50" />
                  <Stat label="En cours" value={stats.pending} color="text-yellow-600 bg-yellow-50" />
                  <Stat label="En retard" value={stats.overdue} color="text-red-600 bg-red-50" />
                  <Stat label="Points" value={stats.totalPoints} color="text-purple-600 bg-purple-50" />
                </div>

                <div className="flex gap-2 mb-3 overflow-x-auto">
                  {[["all","Toutes"],["pending","En cours"],["completed","Terminées"],["today","Aujourd'hui"],["overdue","En retard"]].map(([k,lab])=>(
                    <button key={k} onClick={()=>setFilter(k)} className={"px-3 py-2 rounded-full text-sm whitespace-nowrap "+(filter===k?"bg-blue-600 text-white":"bg-gray-100 text-gray-700")}>{lab}</button>
                  ))}
                </div>

                <div className="space-y-2">
                  {filtered.map(t=>(
                    <TaskCard key={t.id} t={t} onToggle={()=>toggle(t)} onDelete={()=>remove(t)} onEdit={()=>{ setEditing(t); setShowModal(true); }} />
                  ))}
                </div>

                <button onClick={()=>{ setEditing(null); setShowModal(true); }} className="fixed bottom-6 right-6 bg-blue-600 text-white p-4 rounded-full shadow-lg">+</button>
              </div>
            )}

            {tab==="competition" && (
              <div className="space-y-3">
                <div className="bg-white border rounded-xl p-4">
                  <h2 className="font-semibold mb-3">Classement</h2>
                  <div className="space-y-2">
                    {leaderboard.map((u,i)=>(
                      <div key={u.id} className={"flex items-center justify-between p-2 rounded-lg "+(u.id===state.currentUser.id?"bg-blue-50 border-2 border-blue-200":"bg-gray-50")}>
                        <div className="flex items-center gap-3">
                          <div className={"w-8 h-8 rounded-full flex items-center justify-center text-sm font-bold "+(i===0?"bg-yellow-400":i===1?"bg-gray-300":i===2?"bg-orange-400":"bg-gray-200")}>{i<3?["🥇","🥈","🥉"][i]:i+1}</div>
                          <div className="text-2xl">{u.avatar}</div>
                          <div className="font-medium">{u.name}{u.id===state.currentUser.id && <span className="text-blue-600 ml-1">(Vous)</span>}</div>
                        </div>
                        <div className="text-right">
                          <div className="font-bold text-lg text-purple-600">{u.totalPoints}</div>
                          <div className="text-xs text-gray-500">points</div>
                        </div>
                      </div>
                    ))}
                  </div>
                </div>
                <div className="bg-white border rounded-xl p-4">
                  <h2 className="font-semibold mb-3">Défis du jour</h2>
                  <ul className="space-y-2">
                    <li className="flex items-center justify-between bg-blue-50 p-3 rounded-lg"><span>🎯 Terminer 5 tâches</span><span>+10 pts</span></li>
                    <li className="flex items-center justify-between bg-blue-50 p-3 rounded-lg"><span>⚡ Maintenir votre série</span><span>+5 pts</span></li>
                    <li className="flex items-center justify-between bg-blue-50 p-3 rounded-lg"><span>👑 Battre votre record</span><span>+15 pts</span></li>
                  </ul>
                </div>
              </div>
            )}

            {tab==="friends" && (
              <div className="space-y-3">
                <button className="w-full bg-gradient-to-r from-green-500 to-blue-600 text-white p-3 rounded-xl">Inviter un ami</button>
                <div className="space-y-2">
                  {state.friends.map(f=>(
                    <div key={f.id} className="bg-white border rounded-xl p-3 flex items-center justify-between">
                      <div className="flex items-center gap-3">
                        <div className="text-3xl">{f.avatar}</div>
                        <div>
                          <div className="font-medium">{f.name}</div>
                          <div className="text-xs text-gray-500">{f.email}</div>
                        </div>
                      </div>
                      <div className="text-right text-sm">
                        <div>🔥 {f.streak}</div>
                        <div className="text-purple-600 font-semibold">{f.totalPoints} pts</div>
                      </div>
                    </div>
                  ))}
                </div>
              </div>
            )}
          </main>

          <footer className="text-center text-xs text-gray-500 p-3">PWA • Offline • Import/Export JSON</footer>

          {showModal && (
            <TaskModal
              initial={editing || { title:"", description:"", priority:"medium", category:"personnel", dueDate:"", estimatedTime:"" }}
              onClose={()=>{ setShowModal(false); setEditing(null); }}
              onSave={addOrUpdate}
            />
          )}
        </div>
      );
    }

    function Stat({label, value, color}){
      return (
        <div className={"text-center p-2 rounded-lg "+color}>
          <div className="text-lg font-bold">{value}</div>
          <div className="text-xs">{label}</div>
        </div>
      );
    }

    function TaskCard({t, onToggle, onDelete, onEdit}){
      const p = priorities[t.priority] || priorities.medium;
      const c = categories[t.category] || categories.personnel;
      const overdue = t.dueDate && t.dueDate < new Date().toISOString().slice(0,10) && !t.completed;
      return (
        <div className={"bg-white border rounded-xl p-3 shadow-sm "+(t.completed?"opacity-75 bg-gray-50":"")+(overdue?" border-red-200 bg-red-50":" border-gray-200")}>
          <div className="flex items-start gap-3">
            <button onClick={onToggle} className={"w-6 h-6 rounded-full border-2 flex items-center justify-center mt-1 "+(t.completed?"bg-green-500 border-green-500":"border-gray-300")}>
              {t.completed && <span style={{fontSize:"12px"}}>✓</span>}
            </button>
            <div className="flex-1">
              <div className="flex justify-between">
                <div>
                  <div className={"font-medium "+(t.completed?"line-through text-gray-500":"")}>{t.title}</div>
                  {t.description && <div className={"text-sm "+(t.completed?"text-gray-400":"text-gray-600")}>{t.description}</div>}
                </div>
                <div className="text-xs text-gray-500">
                  {t.dueDate && ("🗓 "+formatDate(t.dueDate))}
                </div>
              </div>
              <div className="flex gap-2 mt-2 flex-wrap">
                <span className={"px-2 py-1 rounded-full text-xs font-medium text-white "+c.color}>{c.emoji} {c.label}</span>
                <span className={"px-2 py-1 rounded-full text-xs font-medium "+p.color}>{p.icon} {p.label} (+{p.points}pts)</span>
              </div>
              <div className="flex gap-2 mt-3">
                <button onClick={onEdit} className="px-2 py-1 text-xs border rounded-lg">Modifier</button>
                <button onClick={onDelete} className="px-2 py-1 text-xs border rounded-lg text-red-600">Supprimer</button>
              </div>
            </div>
          </div>
        </div>
      );
    }

    function TaskModal({initial, onClose, onSave}){
      const [task, setTask] = useState(initial);
      const today = new Date().toISOString().slice(0,10);
      return (
        <div className="fixed inset-0 bg-black/50 flex items-end z-50">
          <div className="bg-white w-full rounded-t-2xl p-4">
            <div className="flex items-center justify-between border-b pb-2">
              <h2 className="font-semibold">Tâche</h2>
              <button onClick={onClose}>✕</button>
            </div>
            <div className="grid gap-3 py-3">
              <input className="px-3 py-2 border rounded-lg" placeholder="Titre *" value={task.title} onChange={e=>setTask({...task, title:e.target.value})} />
              <textarea className="px-3 py-2 border rounded-lg" rows="3" placeholder="Description" value={task.description||""} onChange={e=>setTask({...task, description:e.target.value})}></textarea>
              <div className="grid grid-cols-2 gap-3">
                <select className="px-3 py-2 border rounded-lg" value={task.category} onChange={e=>setTask({...task, category:e.target.value})}>
                  {Object.entries(categories).map(([k,v])=>(<option key={k} value={k}>{v.emoji} {v.label}</option>))}
                </select>
                <select className="px-3 py-2 border rounded-lg" value={task.priority} onChange={e=>setTask({...task, priority:e.target.value})}>
                  {Object.entries(priorities).map(([k,v])=>(<option key={k} value={k}>{v.icon} {v.label} (+{v.points}pts)</option>))}
                </select>
              </div>
              <div className="grid grid-cols-2 gap-3">
                <input type="date" className="px-3 py-2 border rounded-lg" min={today} value={task.dueDate||""} onChange={e=>setTask({...task, dueDate:e.target.value})} />
                <input className="px-3 py-2 border rounded-lg" placeholder="Temps estimé (ex: 30min)" value={task.estimatedTime||""} onChange={e=>setTask({...task, estimatedTime:e.target.value})} />
              </div>
            </div>
            <div className="flex gap-3 border-t pt-3">
              <button className="flex-1 px-3 py-2 border rounded-lg" onClick={onClose}>Annuler</button>
              <button className="flex-1 px-3 py-2 rounded-lg text-white bg-blue-600 disabled:opacity-50" disabled={!task.title?.trim()} onClick={()=>onSave(task)}>Enregistrer</button>
            </div>
          </div>
        </div>
      );
    }

    // Utils
    function formatDate(s){ const d=new Date(s); return d.toLocaleDateString('fr-FR',{weekday:'short',month:'short',day:'numeric'}); }
    function scoreTask(t){
      let p = (priorities[t.priority]?.points)||1;
      if(t.dueDate && t.completedAt){
        const due = new Date(t.dueDate); const comp = new Date(t.completedAt);
        if(comp <= due) p += 1;
        const h = comp.getHours(); if(h<8) p+=1; if(h>22) p+=1;
      }
      return p;
    }
    function getStats(tasks){
      const total = tasks.length;
      const completed = tasks.filter(t=>t.completed).length;
      const overdue = tasks.filter(t=>t.dueDate && t.dueDate < new Date().toISOString().slice(0,10) && !t.completed).length;
      const totalPoints = tasks.filter(t=>t.completed).reduce((s,t)=> s+scoreTask(t), 0);
      return { total, completed, overdue, pending: total-completed, totalPoints };
    }
    function userLevel(points){ if(points<50) return 1; if(points<150) return 2; if(points<300) return 3; if(points<500) return 4; return 5; }
    function getLeaderboard(state){
      const users = [state.currentUser, ...state.friends.filter(f=>f.status==="active")];
      return users.sort((a,b)=> b.totalPoints - a.totalPoints);
    }

    // Render
    ReactDOM.createRoot(document.getElementById("root")).render(<App/>);

    // PWA install prompt
    let deferredPrompt = null;
    window.addEventListener('beforeinstallprompt', (e)=>{ e.preventDefault(); deferredPrompt = e; document.getElementById('installPWA').onclick = async ()=>{ if(deferredPrompt){ deferredPrompt.prompt(); deferredPrompt=null; } else alert("Sur mobile : menu → Ajouter à l'écran d'accueil"); }; });
  </script>

  <script>
    if ('serviceWorker' in navigator) {
      window.addEventListener('load', () => {
        navigator.serviceWorker.register('./sw.js');
      });
    }
  </script>
</body>
</html>
