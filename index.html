<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <meta name="theme-color" content="#2563eb"/>
  <title>TaskMaster Social</title>
  <link rel="manifest" href="manifest.json"/>
  <link rel="manifest" href="manifest.webmanifest"/>
  <link rel="icon" href="./icons/icon-192.png"/>
  <script src="https://cdn.tailwindcss.com"></script>
  <!-- React and Babel via CDN for simplicity. In production you should bundle with a build tool. -->
  <script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
  <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
  <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
  <style>html,body,#root{height:100%}</style>
</head>
<body class="bg-gray-50">
  <div id="root"></div>
  <script type="text/babel">
    // Key for localStorage
    const STORAGE_KEY = "taskmaster_social_v1";

    // Default state structure used when nothing exists in localStorage
    const defaultState = {
      me: null,       // current user id
      profiles: [],   // list of user profiles {id, name, avatar, points, level}
      objectives: [], // list of objectives {id, ownerId, title, metric, target, deadline, progress}
      tasks: [],      // list of tasks {id, ownerId, objectiveId, title, desc, priority, dueDate, completed, completedAt}
      cheers: [],     // encouragements {id, toUserId, fromUserId, message, createdAt, type}
      journal: {}     // journal entries keyed by date { [ymd]: { ownerId, mood, note, comments: [] } }
    };

    // Helper: compute user level based on total points. Defined once to avoid duplication.
    function getUserLevel(points) {
      if (points < 50) return 1;
      if (points < 150) return 2;
      if (points < 300) return 3;
      if (points < 500) return 4;
      return 5;
    }

    // Helper: calculate points earned when completing a task
    function calculatePoints(task) {
      // Base on priority: low=1, med=2, high=3
      const priorityPoints = { low: 1, med: 2, high: 3 };
      let pts = priorityPoints[task.priority] || 1;
      if (task.dueDate && task.completedAt) {
        const due = new Date(task.dueDate);
        const comp = new Date(task.completedAt);
        // Bonus if completed on or before due date
        if (comp <= due) pts += 1;
        const hour = comp.getHours();
        // Bonus for early or late completion
        if (hour < 8) pts += 1;
        if (hour > 22) pts += 1;
      }
      return pts;
    }

    // Encode a user profile into a base64 invite token (handles unicode)
    function encodeInvite(data) {
      return btoa(encodeURIComponent(JSON.stringify(data)));
    }

    // Decode a base64 invite token back into a user profile
    function decodeInvite(token) {
      return JSON.parse(decodeURIComponent(atob(token)));
    }

    // Custom hook: load state from localStorage and persist on changes
    function useAppState() {
      const [state, setState] = React.useState(() => {
        try {
          const saved = localStorage.getItem(STORAGE_KEY);
          if (saved) {
            const parsed = JSON.parse(saved);
            // merge saved with default to fill missing keys
            return { ...defaultState, ...parsed };
          }
        } catch (e) {
          console.warn('Failed to parse stored state:', e);
        }
        return { ...defaultState };
      });
      React.useEffect(() => {
        try {
          localStorage.setItem(STORAGE_KEY, JSON.stringify(state));
        } catch (e) {
          console.warn('Failed to store state:', e);
        }
      }, [state]);
      return [state, setState];
    }

    // Profile creation wizard component
    function ProfileWizard({ onCreate }) {
      const [name, setName] = React.useState('');
      const [avatar, setAvatar] = React.useState('üòä');
      const [goalTitle, setGoalTitle] = React.useState('');
      const [metric, setMetric] = React.useState('t√¢ches');
      const [target, setTarget] = React.useState(10);
      const [deadline, setDeadline] = React.useState('');
      return (
        <div className="h-full flex items-center justify-center p-4">
          <div className="bg-white border rounded-2xl max-w-lg w-full p-6 space-y-4">
            <h1 className="text-xl font-bold">Cr√©er mon profil</h1>
            <div className="grid grid-cols-3 gap-3">
              <div className="col-span-3">
                <label className="text-sm text-gray-600">Nom</label>
                <input className="w-full border rounded-lg px-3 py-2" value={name} onChange={e=>setName(e.target.value)} placeholder="Ton nom"/>
              </div>
              <div>
                <label className="text-sm text-gray-600">Avatar (emoji)</label>
                <input className="w-full border rounded-lg px-3 py-2" value={avatar} onChange={e=>setAvatar(e.target.value)} placeholder="üòä"/>
              </div>
              <div className="col-span-2">
                <label className="text-sm text-gray-600">Objectif principal</label>
                <input className="w-full border rounded-lg px-3 py-2" value={goalTitle} onChange={e=>setGoalTitle(e.target.value)} placeholder="Ex: 30 s√©ances de sport"/>
              </div>
              <div>
                <label className="text-sm text-gray-600">M√©trique</label>
                <select className="w-full border rounded-lg px-3 py-2" value={metric} onChange={e=>setMetric(e.target.value)}>
                  <option value="t√¢ches">T√¢ches</option>
                  <option value="heures">Heures</option>
                  <option value="sessions">Sessions</option>
                </select>
              </div>
              <div>
                <label className="text-sm text-gray-600">Cible</label>
                <input type="number" min="1" className="w-full border rounded-lg px-3 py-2" value={target} onChange={e=>setTarget(Number(e.target.value))}/>
              </div>
              <div>
                <label className="text-sm text-gray-600">√âch√©ance</label>
                <input type="date" className="w-full border rounded-lg px-3 py-2" value={deadline} onChange={e=>setDeadline(e.target.value)}/>
              </div>
            </div>
            <button disabled={!name || !goalTitle} className="w-full bg-blue-600 text-white rounded-lg py-2 disabled:opacity-50" onClick={() => onCreate({ name, avatar, goalTitle, metric, target, deadline })}>Cr√©er le profil</button>
          </div>
        </div>
      );
    }

    // Top-level App component
    function App() {
      const [state, setState] = useAppState();
      const [tab, setTab] = React.useState('tasks');
      const [flash, setFlash] = React.useState(null);
      // If no current user, show profile wizard
      if (!state.me) {
        const handleCreate = ({ name, avatar, goalTitle, metric, target, deadline }) => {
          const userId = Date.now();
          const profile = { id: userId, name, avatar: avatar || 'üòä', points: 0, level: 1 };
          const objId = userId + 1;
          const objective = { id: objId, ownerId: userId, title: goalTitle, metric, target: Number(target), deadline, progress: 0 };
          setState(s => ({ ...s, me: userId, profiles: [...s.profiles, profile], objectives: [...s.objectives, objective] }));
          setFlash('Profil cr√©√©¬†‚úÖ');
        };
        return <ProfileWizard onCreate={handleCreate}/>;
      }
      const me = state.profiles.find(p => p.id === state.me);
      // Helper to show a temporary message
      const showFlash = msg => { setFlash(msg); setTimeout(() => setFlash(null), 3000); };
      // Add new objective
      const addObjective = obj => {
        const id = Date.now();
        setState(s => ({ ...s, objectives: [...s.objectives, { id, ownerId: s.me, progress: 0, ...obj }] }));
        showFlash('Objectif ajout√© üéØ');
      };
      // Add new task
      const addTask = task => {
        const id = Date.now();
        setState(s => ({ ...s, tasks: [{ id, ownerId: s.me, completed: false, completedAt: null, ...task }, ...s.tasks] }));
        showFlash('T√¢che ajout√©e üìù');
      };
      // Toggle task completion
      const toggleTask = task => {
        setState(prev => {
          // update tasks array
          const tasks = prev.tasks.map(t => {
            if (t.id === task.id) {
              const completed = !t.completed;
              return { ...t, completed, completedAt: completed ? new Date().toISOString() : null };
            }
            return t;
          });
          // find updated task
          const updated = tasks.find(t => t.id === task.id);
          let profiles = prev.profiles;
          let objectives = prev.objectives;
          if (updated.completed) {
            // Add points to current user
            const pts = calculatePoints(updated);
            profiles = prev.profiles.map(p => {
              if (p.id === prev.me) {
                const total = (p.points || 0) + pts;
                return { ...p, points: total, level: getUserLevel(total) };
              }
              return p;
            });
            // Update objective progress
            if (updated.objectiveId) {
              objectives = prev.objectives.map(o => {
                if (o.id === updated.objectiveId) {
                  const prog = (o.progress || 0) + 1;
                  return { ...o, progress: Math.min(prog, o.target) };
                }
                return o;
              });
            }
          }
          return { ...prev, tasks, profiles, objectives };
        });
      };
      // Save journal entry for today
      const saveJournal = ({ mood, note }) => {
        const today = new Date().toISOString().slice(0, 10);
        setState(s => {
          const entry = s.journal[today] || { ownerId: s.me, comments: [] };
          return { ...s, journal: { ...s.journal, [today]: { ...entry, mood, note } } };
        });
        showFlash('Journal enregistr√© üìì');
      };
      // Cheer a friend
      const cheer = (toUserId, msg = 'Bravo !') => {
        const c = { id: Date.now(), toUserId, fromUserId: state.me, message: msg, type: 'cheer', createdAt: new Date().toISOString() };
        setState(s => ({ ...s, cheers: [c, ...s.cheers] }));
        showFlash('Encouragement envoy√© üëè');
      };
      // Comment on a journal entry
      const commentOnJournal = (date, toUserId, text) => {
        setState(s => {
          const entry = s.journal[date] || { ownerId: toUserId, comments: [] };
          const comments = [...(entry.comments || []), { fromUserId: s.me, text, createdAt: new Date().toISOString() }];
          return { ...s, journal: { ...s.journal, [date]: { ...entry, comments } } };
        });
        showFlash('Commentaire ajout√© üí¨');
      };

      // Add a friend profile from an invite code
      const addFriendFromCode = (token) => {
        try {
          const data = decodeInvite(token.trim());
          // ensure data has id, name, avatar
          if (!data || !data.id || !data.name || !data.avatar) {
            showFlash('Code invalide');
            return;
          }
          setState(s => {
            // do not duplicate existing profiles
            if (s.profiles.some(p => p.id === data.id)) return s;
            const newProfile = { id: data.id, name: data.name, avatar: data.avatar, points: 0, level: 1 };
            return { ...s, profiles: [...s.profiles, newProfile] };
          });
          showFlash('Ami ajout√© ‚úÖ');
        } catch (e) {
          showFlash('Code invalide');
        }
      };
      return (
        <div className="h-full flex flex-col">
          <header className="bg-white border-b">
            <div className="max-w-5xl mx-auto p-3 flex items-center justify-between">
              <div className="flex items-center gap-3">
                <div className="text-2xl">{me.avatar}</div>
                <div>
                  <div className="font-bold">{me.name}</div>
                  <div className="text-xs text-gray-500">Points {me.points || 0} ‚Ä¢ Niveau {me.level || 1}</div>
                </div>
              </div>
              <nav className="flex gap-2">
                {['tasks','objectives','journal','friends','feed'].map(k => (
                  <button key={k} onClick={() => setTab(k)} className={`px-3 py-2 rounded-lg text-sm ${tab===k ? 'bg-blue-600 text-white' : 'bg-gray-100 text-gray-700'}`}>{k==='tasks'?'T√¢ches':k==='objectives'?'Objectifs':k==='journal'?'Journal':k==='friends'?'Amis':'Fil'}</button>
                ))}
              </nav>
            </div>
          </header>
          <main className="max-w-5xl mx-auto p-3 flex-1 w-full overflow-auto">
            {tab === 'tasks' && <TasksView tasks={state.tasks.filter(t => t.ownerId === state.me)} objectives={state.objectives.filter(o=>o.ownerId===state.me)} onAdd={addTask} onToggle={toggleTask}/>} 
            {tab === 'objectives' && <ObjectivesView objectives={state.objectives.filter(o => o.ownerId === state.me)} onAdd={addObjective}/>} 
            {tab === 'journal' && <JournalView entry={state.journal[new Date().toISOString().slice(0,10)]} onSave={saveJournal} />} 
            {tab === 'friends' && <FriendsView me={me} profiles={state.profiles} cheers={state.cheers} onCheer={cheer} onAddFriend={addFriendFromCode} />} 
            {tab === 'feed' && <FeedView state={state} meId={state.me} onComment={commentOnJournal}/>} 
          </main>
          <footer className="text-center text-xs text-gray-500 p-3">PWA ‚Ä¢ Offline ‚Ä¢ Donn√©es locales</footer>
          {flash && <div className="fixed bottom-6 left-1/2 transform -translate-x-1/2 bg-black text-white text-sm px-3 py-2 rounded" >{flash}</div>}
        </div>
      );
    }

    // Tasks view component: list tasks and add new tasks
    function TasksView({ tasks, objectives, onAdd, onToggle }) {
      const [show, setShow] = React.useState(false);
      const [form, setForm] = React.useState({ title: '', desc: '', priority: 'med', dueDate: '', objectiveId: objectives[0] ? objectives[0].id : null });
      const today = new Date().toISOString().slice(0, 10);
      return (
        <div>
          <div className="flex items-center justify-between mb-3">
            <h2 className="font-semibold">Mes t√¢ches</h2>
            <button className="px-3 py-2 rounded-lg bg-blue-600 text-white" onClick={() => setShow(true)}>Nouvelle t√¢che</button>
          </div>
          <div className="space-y-2">
            {tasks.map(t => (
              <div key={t.id} className={`bg-white border rounded-xl p-3 ${t.completed ? 'opacity-70 bg-gray-50' : ''}`}>
                <div className="flex items-start gap-3">
                  <button onClick={() => onToggle(t)} className={`w-6 h-6 rounded-full border-2 flex items-center justify-center ${t.completed ? 'bg-green-500 border-green-500' : 'border-gray-300'}`}>{t.completed ? '‚úì' : ''}</button>
                  <div className="flex-1">
                    <div className="flex justify-between">
                      <div className="font-medium">{t.title}</div>
                      <div className="text-xs text-gray-500">{t.dueDate && ('' + new Date(t.dueDate).toLocaleDateString('fr-FR'))}</div>
                    </div>
                    <div className="text-sm text-gray-600">{t.desc}</div>
                    <div className="text-xs mt-1 flex gap-2 flex-wrap">
                      <span className="px-2 py-1 rounded-full bg-gray-100">Priorit√©: {t.priority}</span>
                      {t.objectiveId && <span className="px-2 py-1 rounded-full bg-blue-50 text-blue-700">üéØ {objectives.find(o => o.id === t.objectiveId)?.title || 'Objectif'}</span>}
                    </div>
                  </div>
                </div>
              </div>
            ))}
            {tasks.length === 0 && <div className="text-gray-500 text-sm">Aucune t√¢che.</div>}
          </div>
          {show && (
            <div className="fixed inset-0 bg-black/50 flex items-end z-50">
              <div className="bg-white w-full rounded-t-2xl p-4">
                <div className="flex items-center justify-between border-b pb-2">
                  <h3 className="font-semibold">Nouvelle t√¢che</h3>
                  <button onClick={() => setShow(false)}>‚úï</button>
                </div>
                <div className="grid gap-3 py-3">
                  <input className="px-3 py-2 border rounded-lg" placeholder="Titre *" value={form.title} onChange={e=>setForm({...form, title:e.target.value})}/>
                  <textarea className="px-3 py-2 border rounded-lg" rows="2" placeholder="Description" value={form.desc} onChange={e=>setForm({...form, desc:e.target.value})}></textarea>
                  <div className="grid grid-cols-2 gap-3">
                    <select className="px-3 py-2 border rounded-lg" value={form.priority} onChange={e=>setForm({...form, priority:e.target.value})}>
                      <option value="low">Faible</option>
                      <option value="med">Moyenne</option>
                      <option value="high">√âlev√©e</option>
                    </select>
                    <input type="date" min={today} className="px-3 py-2 border rounded-lg" value={form.dueDate} onChange={e=>setForm({...form, dueDate:e.target.value})}/>
                  </div>
                  <div>
                    <label className="block text-sm text-gray-600 mb-1">Lier √† un objectif</label>
                    <select className="w-full px-3 py-2 border rounded-lg" value={form.objectiveId || ''} onChange={e=>setForm({...form, objectiveId: e.target.value ? Number(e.target.value) : null})}>
                      <option value="">‚Äî Aucun ‚Äî</option>
                      {objectives.map(o => <option key={o.id} value={o.id}>{o.title}</option>)}
                    </select>
                  </div>
                </div>
                <div className="flex gap-3 border-t pt-3">
                  <button className="flex-1 px-3 py-2 border rounded-lg" onClick={() => setShow(false)}>Annuler</button>
                  <button disabled={!form.title} className="flex-1 px-3 py-2 rounded-lg text-white bg-blue-600 disabled:opacity-50" onClick={() => { onAdd(form); setForm({ title:'', desc:'', priority:'med', dueDate:'', objectiveId: objectives[0] ? objectives[0].id : null }); setShow(false); }}>Enregistrer</button>
                </div>
              </div>
            </div>
          )}
        </div>
      );
    }

    // Objectives view component
    function ObjectivesView({ objectives, onAdd }) {
      const [show, setShow] = React.useState(false);
      const [form, setForm] = React.useState({ title:'', metric:'t√¢ches', target:10, deadline:'' });
      const progressPct = o => o.target ? Math.min(100, Math.round(((o.progress || 0) / o.target) * 100)) : 0;
      return (
        <div>
          <div className="flex items-center justify-between mb-3">
            <h2 className="font-semibold">Mes objectifs</h2>
            <button className="px-3 py-2 rounded-lg bg-blue-600 text-white" onClick={() => setShow(true)}>Nouvel objectif</button>
          </div>
          <div className="grid md:grid-cols-2 gap-3">
            {objectives.map(o => (
              <div key={o.id} className="bg-white border rounded-xl p-4">
                <div className="flex items-center justify-between">
                  <div className="font-medium">üéØ {o.title}</div>
                  <div className="text-xs text-gray-500">{o.deadline && new Date(o.deadline).toLocaleDateString('fr-FR')}</div>
                </div>
                <div className="text-sm text-gray-600">{o.progress || 0} / {o.target} {o.metric}</div>
                <div className="h-2 bg-gray-100 rounded mt-2">
                  <div className="h-2 bg-blue-600 rounded" style={{width: `${progressPct(o)}%`}}></div>
                </div>
              </div>
            ))}
            {objectives.length === 0 && <div className="text-gray-500 text-sm">Aucun objectif.</div>}
          </div>
          {show && (
            <div className="fixed inset-0 bg-black/50 flex items-end z-50">
              <div className="bg-white w-full rounded-t-2xl p-4">
                <div className="flex items-center justify-between border-b pb-2"><h3 className="font-semibold">Nouvel objectif</h3><button onClick={() => setShow(false)}>‚úï</button></div>
                <div className="grid gap-3 py-3">
                  <input className="px-3 py-2 border rounded-lg" placeholder="Titre *" value={form.title} onChange={e=>setForm({...form, title:e.target.value})}/>
                  <div className="grid grid-cols-3 gap-3">
                    <select className="px-3 py-2 border rounded-lg" value={form.metric} onChange={e=>setForm({...form, metric:e.target.value})}>
                      <option value="t√¢ches">T√¢ches</option><option value="heures">Heures</option><option value="sessions">Sessions</option>
                    </select>
                    <input type="number" min="1" className="px-3 py-2 border rounded-lg" value={form.target} onChange={e=>setForm({...form, target:Number(e.target.value)})}/>
                    <input type="date" className="px-3 py-2 border rounded-lg" value={form.deadline} onChange={e=>setForm({...form, deadline:e.target.value})}/>
                  </div>
                </div>
                <div className="flex gap-3 border-t pt-3">
                  <button className="flex-1 px-3 py-2 border rounded-lg" onClick={() => setShow(false)}>Annuler</button>
                  <button disabled={!form.title} className="flex-1 px-3 py-2 rounded-lg text-white bg-blue-600 disabled:opacity-50" onClick={() => { onAdd(form); setForm({ title:'', metric:'t√¢ches', target:10, deadline:'' }); setShow(false); }}>Enregistrer</button>
                </div>
              </div>
            </div>
          )}
        </div>
      );
    }

    // Journal view component: mood slider and note
    function JournalView({ entry, onSave }) {
      const [mood, setMood] = React.useState(entry?.mood || 3);
      const [note, setNote] = React.useState(entry?.note || '');
      return (
        <div className="max-w-2xl">
          <h2 className="font-semibold mb-3">Journal du jour</h2>
          <div className="bg-white border rounded-xl p-4 space-y-3">
            <div>
              <label className="text-sm text-gray-600">Humeur</label>
              <input type="range" min="1" max="5" value={mood} onChange={e=>setMood(Number(e.target.value))} className="w-full"/>
              <div className="text-sm text-gray-500">Humeur: {['üòñ','üòï','üòê','üôÇ','üòÑ'][mood-1]}</div>
            </div>
            <div>
              <label className="text-sm text-gray-600">Commentaire de fin de journ√©e</label>
              <textarea className="w-full border rounded-lg px-3 py-2" rows="4" placeholder="Ce que j'ai appris, difficult√©s, id√©es..." value={note} onChange={e=>setNote(e.target.value)}></textarea>
            </div>
            <button className="px-3 py-2 rounded-lg bg-blue-600 text-white" onClick={() => onSave({ mood, note })}>Enregistrer</button>
          </div>
          <p className="text-xs text-gray-500 mt-2">Tes amis peuvent r√©agir √† ton journal dans l‚Äôonglet <b>Fil</b>.</p>
        </div>
      );
    }

    // Friends view component: list other profiles and allow cheering and invites
    function FriendsView({ me, profiles, cheers, onCheer, onAddFriend }) {
      const [showInvite, setShowInvite] = React.useState(false);
      const [showAdd, setShowAdd] = React.useState(false);
      const [inputCode, setInputCode] = React.useState('');
      // Encode current user profile into an invite token
      const inviteCode = encodeInvite({ id: me.id, name: me.name, avatar: me.avatar });
      const others = profiles.filter(p => p.id !== me.id);
      return (
        <div>
          <h2 className="font-semibold mb-3">Amis</h2>
          <div className="mb-3 flex gap-2">
            <button onClick={() => setShowInvite(true)} className="px-3 py-2 rounded-lg border bg-gray-50">Inviter un ami</button>
            <button onClick={() => setShowAdd(true)} className="px-3 py-2 rounded-lg border bg-gray-50">Ajouter via code</button>
          </div>
          <div className="grid md:grid-cols-2 gap-3">
            {others.map(u => (
              <div key={u.id} className="bg-white border rounded-xl p-4 flex items-center justify-between">
                <div className="flex items-center gap-3">
                  <div className="text-2xl">{u.avatar}</div>
                  <div>
                    <div className="font-medium">{u.name}</div>
                    <div className="text-xs text-gray-500">Points {u.points || 0} ‚Ä¢ Niveau {u.level || 1}</div>
                  </div>
                </div>
                <div className="flex gap-2">
                  <button className="px-3 py-2 rounded-lg border" onClick={() => onCheer(u.id, `Bravo ${u.name} !`)}>üëè Encourager</button>
                </div>
              </div>
            ))}
            {others.length === 0 && <div className="text-gray-500 text-sm">Pas encore d'amis. Tu es la seule personne pour l‚Äôinstant.</div>}
          </div>
          {/* Modal for invite code */}
          {showInvite && (
            <div className="fixed inset-0 bg-black/50 flex items-end z-50">
              <div className="bg-white w-full rounded-t-2xl p-4">
                <div className="flex items-center justify-between border-b pb-2"><h3 className="font-semibold">Inviter un ami</h3><button onClick={() => setShowInvite(false)}>‚úï</button></div>
                <div className="py-3 space-y-3">
                  <div>
                    <label className="text-sm text-gray-600">Mon code :</label>
                    <textarea readOnly className="w-full border rounded-lg px-3 py-2" value={inviteCode}></textarea>
                  </div>
                  <p className="text-xs text-gray-500">Partage ce code avec ton ami. Il peut l'ajouter dans son app via ¬´ Ajouter via code ¬ª.</p>
                </div>
              </div>
            </div>
          )}
          {/* Modal for adding friend via code */}
          {showAdd && (
            <div className="fixed inset-0 bg-black/50 flex items-end z-50">
              <div className="bg-white w-full rounded-t-2xl p-4">
                <div className="flex items-center justify-between border-b pb-2"><h3 className="font-semibold">Ajouter un ami via code</h3><button onClick={() => setShowAdd(false)}>‚úï</button></div>
                <div className="py-3 space-y-3">
                  <input className="w-full border rounded-lg px-3 py-2" placeholder="Code d'invitation" value={inputCode} onChange={e => setInputCode(e.target.value)}/>
                  <div className="flex gap-3">
                    <button className="flex-1 px-3 py-2 border rounded-lg" onClick={() => setShowAdd(false)}>Annuler</button>
                    <button className="flex-1 px-3 py-2 rounded-lg text-white bg-blue-600 disabled:opacity-50" disabled={!inputCode.trim()} onClick={() => { onAddFriend(inputCode); setShowAdd(false); setInputCode(''); }}>Ajouter</button>
                  </div>
                </div>
              </div>
            </div>
          )}
        </div>
      );
    }

    // Feed view component: show cheers and journal comments
    function FeedView({ state, meId, onComment }) {
      const items = [];
      // Add cheers
      state.cheers.forEach(c => items.push({ type:'cheer', ...c }));
      // Add journal entries
      Object.entries(state.journal).forEach(([date, entry]) => {
        items.push({ type:'journal', date, ...entry });
      });
      items.sort((a,b) => new Date((b.createdAt || b.date)) - new Date((a.createdAt || a.date)));
      return (
        <div className="space-y-3">
          <h2 className="font-semibold">Fil social</h2>
          {items.map((it, idx) => {
            if (it.type === 'cheer') {
              const from = state.profiles.find(p => p.id === it.fromUserId);
              const to = state.profiles.find(p => p.id === it.toUserId);
              return (
                <div key={idx} className="bg-white border rounded-xl p-3">
                  <div className="text-sm text-gray-600">üëè {from?.name || ''} a encourag√© {to?.name || ''}</div>
                  <div className="mt-1">{it.message}</div>
                  <div className="text-xs text-gray-500 mt-1">{new Date(it.createdAt).toLocaleString('fr-FR')}</div>
                </div>
              );
            }
            if (it.type === 'journal') {
              const owner = state.profiles.find(p => p.id === it.ownerId) || state.profiles.find(p => p.id === meId);
              return (
                <div key={idx} className="bg-white border rounded-xl p-3">
                  <div className="flex items-center justify-between">
                    <div className="text-sm text-gray-600">üìù Journal de {owner?.name || ''} ‚Äî {new Date(it.date).toLocaleDateString('fr-FR')}</div>
                    <div className="text-sm">{['üòñ','üòï','üòê','üôÇ','üòÑ'][(it.mood || 3) - 1]}</div>
                  </div>
                  <div className="mt-2 text-gray-800">{it.note || <i>Aucun commentaire</i>}</div>
                  <div className="mt-2 space-y-1">
                    {(it.comments || []).map((c, i) => {
                      const from = state.profiles.find(p => p.id === c.fromUserId);
                      return <div key={i} className="text-sm"><b>{from?.name || '?'}</b>: {c.text} <span className="text-xs text-gray-400">({new Date(c.createdAt).toLocaleTimeString('fr-FR')})</span></div>;
                    })}
                  </div>
                  <AddComment date={it.date} toUserId={owner?.id} onComment={onComment}/>
                </div>
              );
            }
            return null;
          })}
          {items.length === 0 && <div className="text-gray-500 text-sm">Rien pour l‚Äôinstant. √âcris dans ton journal ou encourage un ami.</div>}
        </div>
      );
    }

    // AddComment component for leaving a comment on a journal entry
    function AddComment({ date, toUserId, onComment }) {
      const [text, setText] = React.useState('');
      return (
        <div className="mt-2 flex gap-2">
          <input className="flex-1 border rounded-lg px-3 py-2" placeholder="√âcrire un commentaire..." value={text} onChange={e=>setText(e.target.value)}/>
          <button className="px-3 py-2 rounded-lg border" disabled={!text.trim()} onClick={() => { onComment(date, toUserId, text); setText(''); }}>Envoyer</button>
        </div>
      );
    }

    // Render the app
    ReactDOM.createRoot(document.getElementById('root')).render(<App/>);
  </script>
  <script>
    // Register service worker for offline support
    if ('serviceWorker' in navigator) {
      window.addEventListener('load', () => {
        navigator.serviceWorker.register('./sw.js');
      });
    }
  </script>
</body>
</html>